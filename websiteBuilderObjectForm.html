<style>
.hidden {
	display: none !important; 
}
</style>

<form name="inputForm"  autocomplete="on">

<!-- 	<input name="file" id="getimage" type="file" accept="image/*">  -->

	<input type="text" id="personnumber" placeholder="ååmmdd-XXXX" name="userPersonalNumber" pattern="^(19|20)?([0-9]{6})[- ]?([0-9]{4})$" required>   <!-- ng-model="user.orgnr" -->

	<input type="text" id="user-name" placeholder="Förnamn Efternamn" name="userName" required> <!-- ng-model="user.name" ng-model-options="{debounce: 1000}" ng-change="autofillDomain(user.name,user.domainname)" -->

	<input type="email"  id="user-email" placeholder="example@gmail.com" name="userEmail" required> <!-- ng-change="activateCreatePageButton()" ng-model="user.email" -->

	<input type="text" id="user-phone" placeholder="0701234567" name="userPhone" required> <!-- ng-model="user.phone" -->

	<input type="text" id="user-address" placeholder="Kungsgatan 1" name="userAddress" required> <!-- ng-model="user.address1" -->

	<input type="text" id="user-city" name="userCity" placeholder="Stockholm" required> <!-- ng-model="user.city" ng-init="user.city='Stockholm'" -->

	<input type="text" id="user-zipcode" placeholder="12345" name="userZipcode" required> <!-- ng-model="user.zipcode" -->

	<div id="buttondiv">
		<button id="seButton" class="hidden">Select .SE</button><br />
		<button id="nuButton" class="hidden">Select .NU</button><br />
	</div>

	<!-- TODO: Add accept-terms div -->
	<div class="accept-terms">
		<label>
			<fieldset>
				<input type="checkbox"> <!-- ng-model="checkboxModel.value" -->
				Jag godkänner: <br />
				&bull; <a href="https://www.weld.io/terms" target="_blank">Welds användarvillkor</a><br>
				&bull; <a target="_blank" id="domain-terms"></a><br>
				&bull; <a href="https://www.nameisp.com/sv/about/conditions" target="_blank">NameISPs användaravtal</a>
			</fieldset>
		</label>
	</div>
	<!-- TODO: Add error div -->

	<button type="submit">Submit</button>


</form>

<script>

// var DEBUG_MODE = true;

// var SERVER_URL = 'https://www.weld.io/';
// if (DEBUG_MODE === 'staging') {
// 	SERVER_URL = 'https://weld-staging.herokuapp.com/';
// }
// else if (DEBUG_MODE) {
// 	SERVER_URL = 'http://localhost:9000/';
// }

$(document).ready(function() {

		var autofillDomain = function() {
			var user = {};
			user.domainname = $('input[name=userName]').val().toLowerCase().replace(/[\s]/g, '');
			console.log("User domain from autofillDomain func: ", user.domainname);
			searchDomain(user);
		};

		// Listen for a change in the username input and run autofillDomain every 1 sec.
		$('input[name=userName]').on('change', _.debounce(autofillDomain, 1000));

		// Listen for .SE or .NU domain selection and add ToS link to domain-terms
		$('#seButton').on('click', function () {
			$('#domain-terms').attr("href", "https://www.iis.se/domaner/registrera/se/villkor/").text('Avtal för toppdomänen .SE')
		});

		$('#nuButton').on('click', function () {
			$('#domain-terms').attr("href", "https://www.iis.se/docs/terms-and-conditions-nu.pdf").text('Avtal för toppdomänen .NU')
		});

		var searchDomain = _.throttle(function(user) {
				// TODO: Handle the show/hide of buttons
				// Do a jQuery GET request to our domain-staging
				// TODO: Change to the production server
			var searchDomainUrl = "//domain-production-weld.herokuapp.com/api/lookup/" + user.domainname + '.se';
				console.log("Search Domain Url: ",searchDomainUrl);
			$.get(searchDomainUrl, function (data, textStatus, jqXHR) {
				console.log(data, textStatus);
				searchDomainNU(user);
				$('#seButton').html('Select ' + user.domainname + '.se').toggleClass('hidden');
				// TODO: Fix bug where it removes button on 2nd search
			})
			.fail(function(err) {
				console.log("SE Not available:", err.responseText, err);
				$('#seButton').html(user.domainname + '.se is unavailable').toggleClass('hidden');
				searchDomainNU(user);
				// Make the #seButton hide 
			});
		}, 3000);

		// TODO: Add buttons if domain is available or not.
		// TODO: Add link to terms.
		// TODO: Set user.domainname equal to the chosen one

		// After searching for a .SE domain, proceed to search for a .NU domain
		var searchDomainNU = _.throttle(function(user) {
			// TODO: Handle the show/hide of buttons
			// Do a jQuery GET request to our domain-staging
			// TODO: Change to the production server
			var searchDomainUrlNu = "https://domain-production-weld.herokuapp.com/api/lookup/" + user.domainname + '.nu';
			console.log("NU Domain search url: ", searchDomainUrlNu);
			$.get(searchDomainUrlNu, function (data, textStatus, jqXHR) {
				console.log("Search Domain Nu: ", data, textStatus);
				$('#nuButton').html('Select ' + user.domainname + '.nu').toggleClass('hidden');// TODO: Fix bug where it removes button on 2nd search
			})
			.fail(function(err) {
				console.log("NU Not available:", err.responseText, err);
				$('#nuButton').html(user.domainname + '.nu is unavailable').toggleClass('hidden');
				// Make the #nuButton hide
			});
		}, 3000);

	// process the form
	$('form').submit(function(e) {

			// TODO: Add image uploader (Base-64)
			// TODO: Add pictureFile to the User object below

			var user = {
				'orgnr': $('input[name=userPersonalNumber]').val(),
				'name': $('input[name=userName]').val(),
				'email': $('input[name=userEmail]').val(),
				'phone': $('input[name=userPhone]').val(),
				'address1': $('input[name=userAddress]').val(),
				'city': '{{user-city}}' || 'Stockholm',
				'zipcode': $('input[name=userZipcode]').val(),
				'countrycode': '{{user-country}}' || 'se',
				'tags': []
			};

			var register = function() {
				console.log("Placeholder: Hello from the register function");
				// TODO: Create if statement wrapping the whole registration conditional on ToS Checkbox. True = register, False = accept ToS. 
				// TODO: Create activate page button disable here
				// var data = JSON.stringify(user);
				// var registerUrl = SERVER_URL + 'api/users'; 
				// $.post(registerUrl, data)
				// .done(function(data) {
				// 	console.log("Data loaded: ", data)
				// 	// TODO: Handle registration, i.e. show loading image,
				// })
				// .fail(function() {
				// 	console.log("Error registering");
				// 	// TODO: Add an alert to accept ToS.
				// })
				// ;
			};
			register();

	e.preventDefault();
	});

});

</script>